<!DOCTYPE html>
<html lang="zh-TW">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" />
	<link rel="shortcut icon" href="#"/>
	<title>ğŸ“¦ Vue3 è¨‚å–®å¯«å…¥ 1433</title>
	<meta name="description" content="Vue3 è¨‚å–®ç³»çµ±ï¼Œé€£æ¥ Google Sheet å»ºç«‹è¡¨å–®è¨‚å–®">
	<meta property="og:image" content="https://tainmail.github.io/vue_gs_gsheet/images/preview.jpg">

	<!--Bootstrap-->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

	<style>
	@import url(https://fonts.googleapis.com/earlyaccess/notosanstc.css);
	*{font-family:'Noto Sans TC','å¾®è»Ÿæ­£é»‘é«”';}
	html, body {
	overscroll-behavior-y: contain; /* é˜»æ­¢ä¸‹æ‹‰åˆ·æ–° */
	overscroll-behavior-x: none;    /* ç¦æ­¢æ°´å¹³å½ˆè·³ */
	-webkit-overflow-scrolling: touch; /* ä¿ç•™æ…£æ€§æ»‘å‹• */
	}
	</style>

</head>

<body>

	<!--æ‡‰ç”¨ç¨‹å¼ é–‹å§‹-->
	<div id="app" class="wrapper_box container p-1" style="max-width:768px;">

		<!--header_box é–‹å§‹-->
		<div class="header_box p-2" v-if="gSheetData.noteList.length > 0">
			<h1 class="d-flex align-items-center text-primary">
				<i class="bi bi-box-seam me-2 fs-2 "></i>
				{{ gSheetData.noteList[0]['TITLE_1'] }}
			  </h1>
			<h6 class="text-success">æ‚¨å¥½~ {{ userForm.chain }}{{ userForm.shop }} {{ userForm.buyer }}</h6>
			<p class="mb-0">{{gSheetData.noteList[0]['NOTE_1']}}</p>
			<p class="mb-0">{{gSheetData.noteList[0]['NOTE_2']}}</p>
			<p class="mb-0" v-html="gSheetData.noteList[0]['NOTE_3']"></p>
			
		</div>
		<!--header_box çµæŸ-->

		<!--é«”ç³»åº—å é–‹å§‹-->
		<div v-if="gSheetData.chainList.length > 0" class="border rounded px-2 py-3 mb-3">
			<h4 class="bg-primary text-white fs-6 px-3 py-2 rounded-pill mb-3">
				Step 1ï¼šé¸æ“‡çš„åº—å
			</h4>
		
			<p class="d-flex flex-wrap gap-2">
				<select v-model="userForm.chain" class="form-select w-auto border border-secondary ">
					<option value="">é«”ç³»</option>
					<option v-for="(item, idx) in chainOpts" :key="idx" :value="item">
						{{ item }}
					</option>
				</select>
				<select v-model="userForm.shop" class="form-select w-auto border border-secondary " :disabled="!userForm.chain">
					<option value="">åº—å</option>
					<option v-for="(item, idx) in shopOpts" :key="idx" :value="item">
						{{ item }}
					</option>
				</select>
				<input type="text" v-model="userForm.buyer" class="form-control w-auto border border-secondary " placeholder="è«‹è¼¸å…¥è¨‚è³¼äºº" />
			</p>
		</div>
		<!--é«”ç³»åº—å çµæŸ-->


		<!--ç”¢å“åˆ—è¡¨æœå°‹ é–‹å§‹-->
		<div class="border rounded px-2 py-3" style="margin-bottom:200px;">
			<h4 class="bg-primary text-white fs-6 px-3 py-2 rounded-pill mb-3">Step 2ï¼šç”¢å“åˆ—è¡¨æœå°‹</h4>

			<!--åˆ†é¡é¸å–® 1 é–‹å§‹-->
			<section class="btn-group mb-2 d-block" role="group">
				<input type="radio" class="btn-check" id="kind_1" value="æ´—é«®" v-model="userForm.kind" autocomplete="off">
				<label class="btn btn-outline-secondary" for="kind_1">æ´—é«®</label>
			
				<input type="radio" class="btn-check" id="kind_2" value="ä¿®è­·" v-model="userForm.kind" autocomplete="off">
				<label class="btn btn-outline-secondary" for="kind_2">ä¿®è­·</label>
			
				<input type="radio" class="btn-check" id="kind_3" value="é€ å‹" v-model="userForm.kind" autocomplete="off">
				<label class="btn btn-outline-secondary" for="kind_3">é€ å‹</label>
			
				<input type="radio" class="btn-check" id="kind_4" value="ç‡™é«®" v-model="userForm.kind" autocomplete="off">
				<label class="btn btn-outline-secondary" for="kind_4">ç‡™é«®</label>
			
				<input type="radio" class="btn-check" id="kind_5" value="æŸ“é«®" v-model="userForm.kind" autocomplete="off">
				<label class="btn btn-outline-secondary" for="kind_5">æŸ“é«®</label>

				<input type="radio" class="btn-check" id="kind_6" value="è­·é«®" v-model="userForm.kind" autocomplete="off">
				<label class="btn btn-outline-secondary" for="kind_6">è­·é«®</label>
			</section>
			<!--åˆ†é¡é¸å–® 1 çµæŸ-->
			
			<!--åˆ†é¡é¸å–® 2 é–‹å§‹-->
			<section class="btn-group mb-2 d-block" role="group">
				<input type="radio" class="btn-check" id="kind_7" value="é ­çš®ä¿é¤Š" v-model="userForm.kind" autocomplete="off">
				<label class="btn btn-outline-secondary" for="kind_7">é ­çš®ä¿é¤Š</label>
			
				<input type="radio" class="btn-check" id="kind_8" value="å°ˆæ¥­ä¿é¤Š" v-model="userForm.kind" autocomplete="off">
				<label class="btn btn-outline-secondary" for="kind_8">å°ˆæ¥­ä¿é¤Š</label>
			
				<input type="radio" class="btn-check" id="kind_9" value="é›œè²¨è€—æ" v-model="userForm.kind" autocomplete="off">
				<label class="btn btn-outline-secondary" for="kind_9">é›œè²¨è€—æ</label>

				<input type="radio" class="btn-check" id="kind_10" value="ç¾å®¹ä¿é¤Š" v-model="userForm.kind" autocomplete="off">
				<label class="btn btn-outline-secondary" for="kind_10">ç¾å®¹ä¿é¤Š</label>
			</section>
			<!--åˆ†é¡é¸å–® 2 çµæŸ-->
  
			  
			<!--æœå°‹æ¡† é–‹å§‹-->
			<p class="mb-4">
				<input type="text" v-model="userForm.keyword" class="form-control border border-secondary  p-2" placeholder="ğŸ” é—œéµå­—ç”¨åŠå½¢ç©ºæ ¼éš”é–‹">
			</p>
			<!--æœå°‹æ¡† çµæŸ-->
		
			<table class="table table-bordered table-sm table-striped" v-if="searchProductList.length > 0">
				<thead>
					<tr>
						<th class="px-2 py-1 bg-secondary text-white text-start border border-secondary">{{userForm.kind}}ç”¢å“ ({{searchProductList.length}}ç­†)</th>
						<th class="px-2 py-1 bg-secondary text-white text-center border border-secondary" style="width:75px;">æ•¸é‡</th>
					</tr>
				</thead>
				<tbody>
					<tr v-for="(item, idx) in searchProductList" :key="idx">
						<td class="py-3">
							<h6 class="mb-1">ã€{{ item["é¡å‹"] }}ã€‘{{ item["å» å•†"] }}{{ item["å“å"] }} {{ item["è¦æ ¼"] }}</h6>
							<small class="d-block text-danger">å‚™è¨»ï¼š{{ item["å‚™è¨»"] }}</small>
							<small class="d-block text-danger">ç”¢ç·¨ï¼š{{ item["ID"] }}</small>
						</td>
						<td class="py-3 text-center">
							<select v-model.number="tmpCartCount[item.ID]" class="form-select form-select-sm w-100 mb-1 border border-secondary">
								<option v-for="n in 10" :key="n" :value="n">{{ n }}</option>
							</select>
							<button class="btn btn-success btn-sm w-100" @click="fnCartAdd(item)">
								<i class="bi bi-cart-plus me-1"></i>è¨‚è³¼
							  </button>
						</td>
					</tr>
				</tbody>
			</table>
		
			<p v-else class="alert alert-warning py-2 px-3 mb-0 d-flex align-items-center">
				<i class="bi bi-exclamation-triangle-fill me-2"></i>
				ç›®å‰æ²’æ‰¾åˆ°ï¼Œè«‹è¼¸å…¥é—œéµå­—æœå°‹ã€‚
			</p>
		</div>
		<!--ç”¢å“åˆ—è¡¨æœå°‹ çµæŸ-->

		
		<!--æŒ‰éˆ• è³¼ç‰©è»Š é–‹å§‹-->
		<button class="btn btn-dark position-fixed d-flex align-items-center justify-content-center border-3 border-white rounded-circle"
			style="width: 60px; height: 60px; right: 16px; bottom: 88px; z-index: 1050;  box-shadow: 0 0 8px 0px rgba(0, 0, 0, 0.5);"
			@click="bShowCart = true">

			<i class="bi bi-cart text-light" style="font-size:28px;"></i>
		
			<span v-if="cartList.length" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
				style="font-size: 0.7rem;">
				{{ cartList.length }}
			</span>
		</button>
		<!--æŒ‰éˆ• è³¼ç‰©è»Š çµæŸ-->
		
		
		<!--modal è³¼ç‰©è»Š é–‹å§‹-->
		<div class="modal fade show d-block" tabindex="-1" v-if="bShowCart" style="background-color: rgba(0,0,0,0.5);">
			<div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
				<div class="modal-content">
		
					<!-- æ¨™é¡Œå€å¡Š -->
					<header class="modal-header">
						<h5 class="modal-title"><i class="bi bi-cart me-2"></i>è³¼ç‰©è»Š<span v-if="cartList.length" class="badge bg-danger rounded-pill ms-2">
								{{ cartList.length }}
							</span></h5>
						<button type="button" class="btn-close" @click="bShowCart = false"></button>
					</header>
		
					<!-- å…§å®¹å€å¡Š -->
					<section class="modal-body">
						<table class="table table-bordered table-sm table-striped" v-if="cartList.length > 0">
							<thead>
								<tr>
									<th class="px-2 py-1 bg-secondary text-white text-start border border-secondary">ç”¢å“è©³æƒ…</th>
									<th class="px-2 py-1 bg-secondary text-white text-center border border-secondary"
										style="width:75px;">æ•¸é‡</th>
								</tr>
							</thead>
							<tbody>
								<tr v-for="(item, idx) in cartList" :key="idx">
									<td class="py-3">
										<h6 class="mb-1">ã€{{ item["é¡å‹"] }}ã€‘{{ item["å» å•†"] }}{{ item["å“å"] }} {{ item["è¦æ ¼"] }}</h6>
										<small class="d-block text-danger">å‚™è¨»ï¼š{{ item["å‚™è¨»"] }}</small>
										<small class="d-block text-danger">ç”¢ç·¨ï¼š{{ item["ID"] }}</small>
									</td>
									<td class="py-3 text-center">
										<input type="number" v-model="item['è¨‚è³¼æ•¸é‡']" min="1" max="50"
											class="form-control form-control-sm text-center mb-1 w-100 border border-secondary">
										<button class="btn btn-danger btn-sm w-100" @click="fnCartDel(item)">
											<i class="bi bi-trash me-1"></i>åˆªé™¤
										</button>
									</td>
								</tr>
							</tbody>
						</table>
						<p v-else class="alert alert-warning py-2 px-3 mb-2 d-flex align-items-center">
							<i class="bi bi-exclamation-triangle-fill me-2"></i>å°šæœªåŠ å…¥ä»»ä½•å•†å“ã€‚
						</p>

						<!--ç•™è¨€ é–‹å§‹-->
						<div class="mb-3">
							<textarea class="form-control" rows="3" v-model="userForm.comment" placeholder="âœï¸ ç•™è¨€çµ¦ç«™é•·ï¼ˆé¸å¡«ï¼‰"></textarea>
						</div>
						<!--ç•™è¨€ çµæŸ-->
					</section>
		
					<!-- åº•éƒ¨æ“ä½œå€ -->
					<footer class="modal-footer">
						<button class="btn btn-warning text-dark" @click="fnCartSubmit">
							<i class="bi bi-clipboard-check me-1"></i>é€å‡ºè¨‚å–®
						</button>
						<button class="btn btn-secondary" @click="bShowCart = false">é—œé–‰</button>
					</footer>
		
				</div>
			</div>
		</div>
		<!--modal è³¼ç‰©è»Š çµæŸ-->


		<!--modal æˆåŠŸ callback é–‹å§‹-->
		<div class="modal fade show d-block" tabindex="-1" v-if="bShowSuccess" style="background-color: rgba(0,0,0,0.5);">
			<div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
				<div class="modal-content">
		
					<!-- æ¨™é¡Œå€å¡Š -->
					<header class="modal-header">
						<i class="bi bi-check-circle-fill me-1"></i>æˆåŠŸé€å‡º {{ successList.length }} é …å•†å“
						<button type="button" class="btn-close" @click="bShowSuccess = false; successList = []"></button>
					</header>
		
					<!-- å…§å®¹å€å¡Š -->
					<section class="modal-body">
						<table class="table table-bordered table-sm table-striped" v-if="successList.length > 0">
							<thead>
								<tr>
									<th class="px-2 py-1 bg-secondary text-white text-start border border-secondary">ç”¢å“è©³æƒ…</th>
									<th class="px-2 py-1 bg-secondary text-white text-center border border-secondary"
										style="width:75px;">æ•¸é‡</th>
								</tr>
							</thead>
							<tbody>
								<tr v-for="(item, idx) in successList" :key="idx">
									<td class="py-3">
										<h6 class="mb-1">{{ item["å» å•†"] }}{{ item["å“å"] }} {{ item["è¦æ ¼"] }}</h6>
									</td>
									<td class="py-3 text-center">{{ item["è¨‚è³¼æ•¸é‡"] }}</td>
								</tr>
							</tbody>
						</table>
					</section>
		
					<!-- åº•éƒ¨æ“ä½œå€ -->
					<footer class="modal-footer">
						<button class="btn btn-secondary" @click="bShowSuccess = false; successList=[];">é—œé–‰</button>
					</footer>
		
				</div>
			</div>
		</div>
		<!--modal æˆåŠŸ callback çµæŸ-->


		<!--æŒ‰éˆ• æŸ¥è©¢æ­·å²è¨‚å–® é–‹å§‹-->
		<button
			class="btn btn-warning position-fixed d-flex align-items-center justify-content-center border-3 border-white rounded-circle"
			style="width: 60px; height: 60px; right: 16px; bottom: 16px; z-index: 1050; box-shadow: 0 0 8px 0px rgba(0, 0, 0, 0.5);"
			@click="fnHistory">
			<i class="bi bi-clock-history text-dark" style="font-size:28px;"></i>
		</button>
		<!--æŒ‰éˆ• æŸ¥è©¢æ­·å²è¨‚å–® çµæŸ-->


		<!--modal æ­·å²è¨‚å–®åˆ—è¡¨ é–‹å§‹-->
		<div class="modal fade show d-block" tabindex="-1" v-if="bShowHistory" style="background-color: rgba(0,0,0,0.5);">
			<div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
				<div class="modal-content">
		
					<!-- æ¨™é¡Œå€å¡Š -->
					<header class="modal-header">
						<i class="bi bi-clock-history me-1"></i>æ­·å²è¨‚å–® {{userForm.chain}} {{userForm.shop}}  
						<button type="button" class="btn-close" @click="bShowHistory = false; successList = []"></button>
					</header>
		
					<!-- å…§å®¹å€å¡Š -->
					<section class="modal-body">
						<!--è¡¨ é–‹å§‹-->
						<div v-if="Object.keys(gSheetData.historyList).length">
							<section v-for="(orderGroup, orderTime) in gSheetData.historyList" :key="orderTime" class="mb-4">
								<table class="table table-bordered table-sm table-striped" v-if="orderGroup.length > 0">
									<thead>
										<tr>
											<th class="px-2 py-1 bg-secondary text-white text-start border border-secondary">
												<i class="bi bi-clock-history me-2"></i>{{ orderTime }} <br> {{orderGroup[0]["è¨‚è³¼äºº"]}} è¨‚è³¼
												{{orderGroup.length}}ç­† 
											</th>
											<th class="px-2 py-1 bg-secondary text-white text-center border border-secondary"
												style="width:75px;">æ•¸é‡</th>
										</tr>
									</thead>
									<tbody>
										<tr v-for="(item, idx) in orderGroup" :key="idx">
											<td class="py-3">
												<h6 class="mb-1">{{ item["å» å•†"] }}{{ item["å“å"] }} {{ item["è¦æ ¼"] }}</h6>
												<small class="d-block text-danger">å‚™è¨»ï¼š{{ item["å‚™è¨»"] }}</small>
												<small class="d-block text-danger">ç”¢ç·¨ï¼š{{ item["ID"] }}</small>
												<small class="d-block text-danger">ç•™è¨€ï¼š{{ item["ç•™è¨€"] }}</small>
											</td>
											<td class="py-3 text-center">
												{{item["è¨‚è³¼æ•¸é‡"]}}
											</td>
										</tr>
									</tbody>
								</table>
							</section>
						</div>
						<div v-else class="alert alert-warning d-flex align-items-center">
							<i class="bi bi-exclamation-triangle-fill me-2"></i>
							å°šç„¡ç¬¦åˆæ¢ä»¶çš„æ­·å²è¨‚å–®ã€‚
						  </div>
						<!--è¡¨ çµæŸ-->
					</section>
		
					<!-- åº•éƒ¨æ“ä½œå€ -->
					<footer class="modal-footer">
						<button class="btn btn-secondary" @click="bShowHistory = false;">é—œé–‰</button>
					</footer>
		
				</div>
			</div>
		</div>
		<!--modal æ­·å²è¨‚å–®åˆ—è¡¨ çµæŸ-->

		

		<!--loading é–‹å§‹-->
		<div v-if="bShowLoading"
			class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center"
			style="background-color: rgba(0, 0, 0, 0.6); z-index: 2000;">
			<div class="spinner-border text-light" role="status">
				<span class="visually-hidden">Loading...</span>
			</div>
		</div>
		<!--loading çµæŸ-->

		<!--modal Alert å…ƒä»¶ é–‹å§‹-->
		<div class="modal fade show d-block" tabindex="-1" v-if="alertMsg" style="background-color: rgba(0, 0, 0, 0.5);">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
		
					<!-- æ¨™é¡Œå€å¡Š -->
					<div class="modal-header">
						<h5 class="modal-title">ç³»çµ±æç¤º</h5>
						<button type="button" class="btn-close" @click="alertMsg = ''"></button>
					</div>
		
					<!-- å…§å®¹æ–‡å­— -->
					<div class="modal-body">
						<section class="mb-0" v-html="alertMsg"></section>
					</div>
		
					<!-- åº•éƒ¨æ“ä½œ -->
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" @click="alertMsg = ''">ç¢ºå®š</button>
					</div>
		
				</div>
			</div>
		</div>
		<!--modalAlert å…ƒä»¶ çµæŸ-->

		
	</div>
	<!--æ‡‰ç”¨ç¨‹å¼ çµæŸ-->

	<script>
		//è¨‚å–® gs å¯«å…¥ gsheet
		// cartList       è¦é€å‡ºçš„è¨‚å–®è³‡æ–™é™£åˆ—
		// cbStart        å‚³é€å‰åŸ·è¡Œï¼ˆå¦‚é¡¯ç¤º loadingï¼‰
		// cbSuccess      å‚³é€æˆåŠŸæ™‚åŸ·è¡Œï¼ˆåƒæ•¸ç‚ºå›å‚³çµæœï¼‰
		// cbError        å‚³é€å¤±æ•—æ™‚åŸ·è¡Œï¼ˆåƒæ•¸ç‚ºéŒ¯èª¤è¨Šæ¯ï¼‰
		// cbFinally      æœ€å¾Œä¸€å®šæœƒåŸ·è¡Œï¼ˆæˆåŠŸæˆ–å¤±æ•—çš†æœƒè§¸ç™¼ï¼‰
		async function fnCart_GScript_GSheet(cartList, { cbStart, cbSuccess, cbError, cbFinally } = {}) {

			//gs
			const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxURK88YznI6MJ7dnAKwjGkzNFlgM3c-hyCcX3CQJZvpXOuGYqP7GC88n_rQWlEJtYpCw/exec";

			if (cbStart) cbStart();

			console.log('ğŸŸ¡ æ­£åœ¨é€å‡ºè¨‚å–®...');

			try {
				const response = await fetch(WEB_APP_URL, {
					method: 'POST',
					body: JSON.stringify(cartList)
				});

				if (response.ok) {
					const result = await response.json();

					if (result.status === 'success') {
						console.log('âœ… è¨‚å–®å·²æˆåŠŸé€å‡º');

						if (cbSuccess) cbSuccess(result);

					} else {
						console.log(`âš ï¸ éŒ¯èª¤ï¼š${result.message}`);
						if (cbError) cbError(result.message);
					}
				} else {
					const errorText = await response.text();
					console.log(`âŒ ä¼ºæœå™¨éŒ¯èª¤ï¼š${response.status} ${errorText}`);
					if (cbError) cbError(errorText);
				}

			} catch (error) {
				console.log(`ğŸš« å‚³é€å¤±æ•—ï¼š${error.message}`);
				console.error('Fetch ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
				if (cbError) cbError(error.message);
			} finally {
				if (cbFinally) cbFinally();
			}
		}
	</script>

	<script>
	// è®€å– gsheet csv
	// çµ±ä¸€ä½¿ç”¨ gid æ¨¡å¼ï¼šç”± Google Sheet çš„ç™¼ä½ˆ ID èˆ‡å·¥ä½œè¡¨ gid å–å¾—è³‡æ–™
	// argPublicID    Google Sheet ç™¼ä½ˆå¾Œçš„ IDï¼ˆ
	// argGid         å·¥ä½œè¡¨çš„ gid ç·¨è™Ÿ
	// å›å‚³å€¼         è§£æå¾Œçš„è³‡æ–™é™£åˆ—ï¼Œæ¯ç­†ç‚ºç‰©ä»¶
	async function fnFetchSheetCSV(argPublicID, argGid) {
		const url = `https://docs.google.com/spreadsheets/d/e/${argPublicID}/pub?output=csv&gid=${argGid}`;

		try {
			const res = await fetch(url);
			const csvText = await res.text();

			const rows = csvText.trim().split("\n").map(row => row.split(","));
			const headers = rows[0];

			const json = rows.slice(1).map(row => {
				const obj = {};
				row.forEach((val, idx) => {
					const cleanKey = headers[idx].replace(/[\r\n]+/g, "").trim();
					const cleanVal = val.replace(/[\r\n]+/g, "").trim();
					obj[cleanKey] = cleanVal;
				});
				return obj;
			});

			return json;

		} catch (err) {
			console.error("âŒ ç„¡æ³•è®€å– Google Sheetï¼ˆgidï¼‰è³‡æ–™ï¼š", err);
			return [];
		}
	}
	</script>

	<script>
	// è®€å– æ­·å²è¨‚å–® gsheet csv
	// sheetUrl       Google Sheet åŒ¯å‡º CSV çš„å®Œæ•´ç¶²å€ï¼ˆå« gidï¼‰
	// å›å‚³å€¼         æ’åºå¾Œçš„è³‡æ–™é™£åˆ—ï¼Œæ¯ç­†ç‚ºç‰©ä»¶ï¼›éŒ¯èª¤æ™‚å›å‚³ç©ºé™£åˆ— []
	async function fnFetchSheetHistoryCSV(sheetUrl) {
		try {
			const res = await fetch(sheetUrl);
			const csvText = await res.text();

			const rows = csvText.trim().split("\n").map(row => row.split(","));

			if (rows.length < 6) {
				console.warn("â— è³‡æ–™è¡Œæ•¸ä¸è¶³");
				return [];
			}

			// ç¬¬ 5 åˆ—ç‚ºè¡¨é ­
			const headers = rows[4].map(h => h.trim().replace(/[\r\n]+/g, ""));

			// ç¬¬ 6 åˆ—é–‹å§‹æ‰æ˜¯æœ‰æ•ˆè³‡æ–™
			const dataRows = rows.slice(5);

			const allItems = dataRows.map(row => {
				const item = {};
				row.forEach((val, idx) => {
					const key = headers[idx] || `æœªå‘½åæ¬„ä½${idx}`;
					item[key] = val.trim().replace(/[\r\n]+/g, "");
				});
				return item;
			});

			// ä¾è¨‚å–®æ™‚é–“æ’åºï¼šæ–° â†’ èˆŠ
			allItems.sort((a, b) => {
				const tA = new Date(a["è¨‚å–®æ™‚é–“"]);
				const tB = new Date(b["è¨‚å–®æ™‚é–“"]);
				return tB - tA;
			});

			return allItems;

		} catch (err) {
			console.error("âŒ ç„¡æ³•è®€å– Google Sheet è³‡æ–™ï¼š", err);
			return [];
		}
	}
	</script>



	<script type="module">
		import { createApp, ref, reactive, computed, onMounted, watch, watchEffect } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';

		const app = createApp({
			setup() {

				//ç”±ç™¼ä½ˆåˆ°ç¶²è·¯å–å¾— argPublicID è³‡æ–™è¡¨åç¨±sheetName
				const publicID = "2PACX-1vSciyoqom00dwm7X-naII5bMxSygPSnzvTZMwhcpLtIenmR682WEkolx6qbJD-ERnmmHkupVEs2RXMa";

				//gsheet fetch csv
				const gSheetData = reactive({
					productList: [], //ç”¢å“åˆ—è¡¨
					chainList: [], //é€£é– åº—å
					noteList:[], //ç¶²é ç¶­è­·ã€å…¬å‘Š
					historyList:[], //æ­·å²è¨‚å–®
				});


				//ä»¥å•†å“ ID ç‚º keyã€è¨˜éŒ„ç›®å‰è¼¸å…¥æ•¸é‡
				const tmpCartCount = reactive({});

				// åŠ å…¥è³¼ç‰©è»Š
				const fnCartAdd = (item) => {
					const qty = parseInt(tmpCartCount[item["ID"]] || 0);

					if (!qty || qty <= 0) {
						alertMsg.value = "<p>â—è«‹è¼¸å…¥æ­£ç¢ºçš„è¨‚è³¼æ•¸é‡</p>";
						return;
					}

					const existing = cartList.value.find(o => o["ID"] === item["ID"]);

					if (existing) {
						existing["è¨‚è³¼æ•¸é‡"] += qty;
					} else {
						cartList.value.push({
							...item,
							"è¨‚è³¼æ•¸é‡": qty,
						});
					}

					alertMsg.value = `<p>âœ… å·²åŠ å…¥è¨‚å–®ï¼š</p> <p>${item.å“å} Ã— ${qty}</p>`;

					tmpCartCount[item["ID"]] = ""; // æ¸…ç©ºè¼¸å…¥æ¬„
				};

				


				// è³¼ç‰©è»Šè³‡æ–™
				const cartList = ref([
				
				]);

				/*
				{ "ID": "fruit_1", "å» å•†": "æœç„¶å¥½", "å“å": "è˜‹æœ", "è¦æ ¼": "1ç®±", "è¨‚è³¼æ•¸é‡": 3, "é¡å‹": "å‰Šçš®", "å‚™è¨»": "æœ‰æ©Ÿ" },
				{ "ID": "fruit_2", "å» å•†": "é®®æœæ¨‚", "å“å": "é¦™è•‰", "è¦æ ¼": "2ä¸²", "è¨‚è³¼æ•¸é‡": 5, "é¡å‹": "æœä¹¾", "å‚™è¨»": "ç¬¬ä¸‰å­£åˆ°è²¨" },
				{ "ID": "meat_1", "å» å•†": "å¤§å£è‚‰å“", "å“å": "ç‰›è‚‰ç‰‡", "è¦æ ¼": "500g", "è¨‚è³¼æ•¸é‡": 2, "é¡å‹": "ç”Ÿé£Ÿ", "å‚™è¨»": "" },
				{ "ID": "meat_2", "å» å•†": "æ–°é®®è‚‰èˆ–", "å“å": "é›è…¿æ’", "è¦æ ¼": "1åŒ…", "è¨‚è³¼æ•¸é‡": 4, "é¡å‹": "ç”Ÿé£Ÿ", "å‚™è¨»": "" },
				{ "ID": "meat_3", "å» å•†": "è€å¼µè‚‰èˆ–", "å“å": "è±¬çµè‚‰", "è¦æ ¼": "300g", "è¨‚è³¼æ•¸é‡": 3, "é¡å‹": "ç”Ÿé£Ÿ", "å‚™è¨»": "çœŸç©ºå†·è—" },
				*/

				// é¡¯ç¤º loading
				const bShowLoading = ref(false);

				// é¡¯ç¤º è³¼ç‰©è»Š
				const bShowCart = ref(false);

				// é¡¯ç¤º æˆåŠŸæ¸…å–®
				const bShowSuccess = ref(false);

				// é¡¯ç¤º æ­·å²è¨‚å–®
				const bShowHistory = ref(false);

				
				//Alert å…ƒä»¶ã€‚å¡æ–‡å­—é€²å»å°±æœƒshow
				const alertMsg = ref("");

				//è¨‚å–®å¯«å…¥ gsheet æˆåŠŸ callback æ¸…å–®
				const successList = ref([]);

				//ä½¿ç”¨è€…å¡«å¯«
				const userForm = reactive({
					chain: "", //é€£é–
					shop: "", //åº—
					buyer:"", //è¨‚è³¼äºº
					kind:"æ´—é«®", //ç”¢å“å¤§é¡
					keyword:"", //æœç”¢å“
					comment:"" //ç•™è¨€
				});

				
				//è¨˜éŒ„ é€£é– åº— è¨‚è³¼äºº
				const userFormStorage = {
					key: "userFormStorage_03",

					fnRead() {
						const saved = JSON.parse(localStorage.getItem(this.key));
						if (saved) {
							userForm.chain = saved.chain || "";
							userForm.shop = saved.shop || "";
							userForm.buyer = saved.buyer || "";
						}
					},

					fnSave() {
						const data = {
							chain: userForm.chain,
							shop: userForm.shop,
							buyer: userForm.buyer
						};
						localStorage.setItem(this.key, JSON.stringify(data));
					}
				};


				// gid å°ç…§è¡¨ å› ç‚ºç­†æ•¸éå¤šéœ€åˆ†é¡è¼‰å…¥
				const productGidMap = {
					"æ´—é«®": "281779668",
					"ä¿®è­·": "1839910507",
					"é€ å‹": "48717049",
					"ç‡™é«®": "165622397",
					"æŸ“é«®": "975624467",
					"è­·é«®": "1260117740",
					"é ­çš®ä¿é¤Š": "1633371124",
					"å°ˆæ¥­ä¿é¤Š": "771666379",
					"é›œè²¨è€—æ": "237824708",
					"ç¾å®¹ä¿é¤Š": "986861454"
				};


				//computed é«”ç³»é¸é …
				const chainOpts = computed(() => {
					return gSheetData.chainList
						.filter(item => item["PID"] === "")
						.map(item => item["NAME"]);
				});

				//computed ä¾æ“šé«”ç³»é¸å‡ºå°æ‡‰çš„åº—åé¸é …
				const shopOpts = computed(() => {
					return gSheetData.chainList
						.filter(item => item["PID"] === userForm.chain)
						.map(item => item["NAME"]);
				});

				//computed ç”¢å“æœå°‹
				const searchProductList = computed(() => {
					if (!userForm.keyword.trim()) return gSheetData.productList;

					const words = userForm.keyword.replace(/\u3000/g, " ").trim().toLowerCase().split(/\s+/);

					return gSheetData.productList.filter(item => {
						const haystack = `${item["ID"]}${item["å» å•†"]}${item["å“å"]}${item["è¦æ ¼"]}${item["é¡å‹"]}${item["å‚™è¨»"]}`
							.replace(/\u3000/g, " ")  // è™•ç† haystack å…¨å½¢ç©ºç™½
							.toLowerCase();
						return words.every(word => haystack.includes(word));
					});
				});

				// è³¼ç‰©è»Š åˆªé™¤å•†å“
				const fnCartDel = (item) => {
					const idx = cartList.value.findIndex(o => o.ID === item.ID);
					if (idx !== -1) {
						cartList.value.splice(idx, 1);
					}
				};

				// è³¼ç‰©è»Š å‚³é€è¨‚å–®
				const fnCartSubmit = () => {

					// é©—è­‰ é€£é– åº—å è¨‚è³¼äºº
					if (!userForm.chain || !userForm.shop || !userForm.buyer) {
						bShowCart.value = false;
						alertMsg.value = "<p>ğŸš«ã€é«”ç³»ã€ã€åº—åã€ã€è¨‚è³¼äººã€</p><p>ç‚ºå¿…å¡«æ¬„ä½ï¼Œè«‹ç¢ºèªå¾Œå†é€å‡ºè¨‚å–®ï¼</p>";
						return;
					}

					// é©—è­‰æœ‰å–®
					if (cartList.value.length === 0) {
						bShowCart.value = false;
						alertMsg.value = "<p>ğŸš« æ²’æœ‰å•†å“å¯é€å‡ºã€‚</p>";
						return;
					}

					const timeUTC = new Date().toISOString(); // æ©Ÿå™¨ç”¨ UTC æ™‚é–“
					const timeLocal = new Date().toLocaleString(); // åœ¨åœ°æ™‚é–“

					//åŠ å·¥è³‡æ–™
					const cartWithTime = cartList.value.map(item => ({
						...item,
						"è¨‚å–®æ™‚é–“": timeLocal,
						"æ¨™æº–æ™‚é–“": timeUTC, 
						"é«”ç³»": userForm.chain,
						"åº—å": userForm.shop,
						"è¨‚è³¼äºº": userForm.buyer,
					}));

					// ç¬¬ä¸€ç­† åŠ ç•™è¨€
					if (userForm.comment && cartWithTime.length > 0) {
						cartWithTime[0]["ç•™è¨€"] = userForm.comment;
					}

					// å¯«å…¥é›²ç«¯ã€‚å®Œæˆå¾Œcallback
					fnCart_GScript_GSheet(cartWithTime, {
						cbStart: () => {
							bShowLoading.value = true;
						},
						cbSuccess: (res) => {
							console.log("âœ… cbSuccess writtenDataå°æ‡‰ï¼š", res);

							//å¯«å…¥æˆåŠŸæ¸…å–® writtenData æ˜¯ç…§sheetæ’åºå°æ‡‰ï¼Œéœ€æ‰‹å‹•å°æ‡‰
							if (res && Array.isArray(res.writtenData)) {
								successList.value = res.writtenData.map(row => ({
									"å» å•†": row[5],
									"å“å": row[6],
									"è¦æ ¼": row[8],
									"è¨‚è³¼æ•¸é‡": row[7]
								}));
								bShowSuccess.value = true;
							}
							
							cartList.value = []; // æ¸…ç©ºè³¼ç‰©è»Š
							Object.keys(tmpCartCount).forEach(key => delete tmpCartCount[key]); // æ¸…ç©ºæ•¸é‡
							userForm.comment = "" // æ¸…ç©ºç•™è¨€
						},
						cbFinally: () => {
							bShowCart.value = false
							bShowLoading.value = false;
						}
					});
				};

				//è®€å–æ­·å²è¨‚å–®
				const fnHistory = async () => {
					
					if (!userForm.chain || !userForm.shop) {
						alertMsg.value = "<p>âš ï¸ è«‹å…ˆé¸æ“‡ã€é«”ç³»ã€èˆ‡ã€åº—åã€å¾Œï¼Œæ‰èƒ½æŸ¥è©¢æ­·å²è¨‚å–®ã€‚</p>";
						return;
					}

					const rawList = await fnFetchSheetHistoryCSV("https://docs.google.com/spreadsheets/d/1DZbJEi3lDsnOO2uA9dUDNYoyUYvGi8ULOJVGkfyzy88/export?format=csv&gid=0");

					const tmpObj = {};

					for (const item of rawList) {
						if (item["é«”ç³»"] !== userForm.chain || item["åº—å"] !== userForm.shop) continue;

						const orderTime = item["è¨‚å–®æ™‚é–“"] || "æœªæŒ‡å®šæ™‚é–“";

						if (!tmpObj[orderTime]) {
							tmpObj[orderTime] = [];
						}
						tmpObj[orderTime].push(item);
					}

					gSheetData.historyList = tmpObj;
					bShowHistory.value = true;
				};



				// watch ä½¿ç”¨è€…è¼¸å…¥è®Šæ›´æ™‚ï¼Œé«”ç³»é‡é¸æ¸…ç©ºåº—å
				watch(()=>userForm.chain, (newVal, oldVal)=>{
					if (oldVal && newVal !== oldVal && userForm.shop) userForm.shop = "";
				});

				// watch è¨˜éŒ„ é€£é– åº— è¨‚è³¼äºº
				watch( 
					() => [userForm.chain, userForm.shop, userForm.buyer], 
					() => { userFormStorage.fnSave() }
				);

				// watch ç”¢å“åˆ†é¡ å‹•æ…‹è¼‰æ•™
				watch(()=>userForm.kind, async (newVal, oldVal)=>{
					
					//loading
					bShowLoading.value = true;

					// ç”¢å“è¡¨
					gSheetData.productList = await fnFetchSheetCSV(publicID, productGidMap[userForm.kind]);

					//loading
					bShowLoading.value = false;
				});

				// onMounted
				onMounted(async () => {

					//loading
					bShowLoading.value = true;

					// ç¶²é æ–‡æ¡ˆ
					gSheetData.noteList = await fnFetchSheetCSV(publicID, "418186417");

					// è¨­å®š HTML ç¶²é æ¨™é¡Œ
					if (gSheetData.noteList.length && gSheetData.noteList[0]["TITLE_1"]) {
						document.title = gSheetData.noteList[0]["TITLE_1"];
					}

					// é«”ç³»è¡¨
					gSheetData.chainList = await fnFetchSheetCSV(publicID, "679743566");

					// ç”¢å“è¡¨
					gSheetData.productList = await fnFetchSheetCSV(publicID, productGidMap[userForm.kind]);

					//loading
					bShowLoading.value = false;

					//è®€å– è¨˜éŒ„ é€£é– åº— è¨‚è³¼äºº
					userFormStorage.fnRead();
					
				});

				return {
					// è³¼ç‰©è»Šç›¸é—œ
					cartList,           // è³¼ç‰©è»Šæ¸…å–®
					successList,        // æˆåŠŸé€å‡ºçš„è¨‚å–®æ¸…å–®
					tmpCartCount,       // æ¯å€‹å•†å“çš„æš«å­˜é¸æ“‡æ•¸é‡
					fnCartAdd,          // åŠ å…¥è³¼ç‰©è»Š
					fnCartDel,          // å¾è³¼ç‰©è»Šç§»é™¤
					fnCartSubmit,       // æäº¤è¨‚å–®

					// é¡¯ç¤ºæ§åˆ¶
					bShowCart,          // é¡¯ç¤ºè³¼ç‰©è»Š Modal
					bShowSuccess,       // é¡¯ç¤ºæˆåŠŸé€å‡º Modal
					bShowHistory,       // é¡¯ç¤ºæ­·å²è¨‚å–® Modal
					bShowLoading,       // é¡¯ç¤º Loading Spinner
					alertMsg,           // ç³»çµ±æç¤ºè¨Šæ¯ï¼ˆAlert Modalï¼‰

					// è³‡æ–™ä¾†æºèˆ‡æŸ¥è©¢çµæœ
					gSheetData,            // æ‰€æœ‰å¾Œå°è³‡æ–™ï¼ˆç”¢å“åˆ—è¡¨ã€é«”ç³»åº—åã€å…¬å‘Šã€æ­·å²è¨‚å–®ï¼‰
					searchProductList,  // æœå°‹å¾Œçš„ç”¢å“æ¸…å–®ï¼ˆcomputedï¼‰

					// ä½¿ç”¨è€…è¼¸å…¥è¡¨å–®
					userForm,           // ä½¿ç”¨è€…å¡«å¯«çš„è¡¨å–®è³‡æ–™ï¼ˆé«”ç³»ã€åº—åã€è¨‚è³¼äººç­‰ï¼‰
					chainOpts,          // é«”ç³»é¸é …ï¼ˆcomputedï¼‰
					shopOpts,           // åº—åé¸é …ï¼ˆcomputedï¼‰

					// æ­·å²è¨‚å–®
					fnHistory           // æŸ¥è©¢æ­·å²è¨‚å–®
				};
			}
		});

		app.mount("#app");
	</script>

</body>

</html>